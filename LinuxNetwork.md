# Сети в Linux

## Part 1. Инструмент **ipcalc**

**== Задание ==**

##### Подними виртуальную машину (далее -- ws1)

#### 1.1. Сети и маски
##### Определи и запиши в отчёт:
##### 1) Адрес сети *192.167.38.54/13*
##### 2) Перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и префиксную
##### 3) Минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

Устанавливаем утилиту ipcalc 
```sudo apt install ipcalc```

Выполняем ```ipcalc 192.167.38.54/13```

![alt text](images/image.png)

##### 1) Определили адрес сети:
```192.160.0.0/13```
##### 2) Перевод маски 255.255.255.0 в префиксную и двоичную запись

```ipcalc 255.255.255.0```

![alt text](images/image-2.png)

Префиксная:    /24 - находим в строке Netmask
Двоичная:   11111111.11111111.11111111.00000000 - тоже в строке Netmask

Перевод маски /15 в обычную и двоичную

```ipcalc 0.0.0.0/15```

![alt text](images/image-4.png)

Обычная: 255.254.0.0
Двоичная: 11111111.11111110.00000000.00000000

Перевод маски 11111111.11111111.11111111.11110000 в обычную и префиксную

```ipcalc 0.0.0.0/28```

![alt text](images/image-5.png)

Обычная запись: 192.168.1.1
Префиксная запись: 28

##### 3) Определили минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

*/8*

```ipcalc 12.167.38.4/8```

![alt text](images/image-6.png)

Минимальный хост: 12.0.0.1
Максимальный хост: 12.255.255.254

*11111111.11111111.00000000.00000000*

```ipcalc 12.167.38.4/16```

![alt text](images/image-7.png)

Минимальный хост: 12.167.0.1
Максимальный хост: 12.167.255.254

*255.255.254.0*

```ipcalc 12.167.38.4 255.255.254.0```

![alt text](images/image-9.png)

Минимальный хост: 12.167.38.1
Максимальный хост: 12.167.39.254

*/4* 

```ipcalc 12.167.38.4/4```

![alt text](images/image-8.png)

Минимальный хост: 0.0.0.1
Максимальный хост: 15.255.255.255


#### 1.2. localhost

##### Определи и запиши в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*


localhost = весь диапазон 127.0.0.0/8
(от 127.0.0.1 до 127.255.255.254)

Можно обратиться:
*127.0.0.2*
*127.1.0.1*

Нельзя обратиться:
*194.34.23.100*
*128.0.0.1*

#### 1.3. Диапазоны и сегменты сетей
##### Определи и запиши в отчёт:
##### 1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*
##### 2) Какие из перечисленных IP-адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

##### 1) Определяем, какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

Частные диапазоны
10.0.0.0 - 10.255.255.255 (весь диапазон 10.x.x.x)

172.16.0.0 - 172.31.255.255 (только с 16 по 31!)

192.168.0.0 - 192.168.255.255 (только 192.168.x.x)

IP публичные:
*134.43.0.2*
*172.0.2.1*
*192.172.0.1*
*172.68.0.2*
*192.169.168.1*

IP частные:
*10.0.0.45*
*192.168.4.2*
*172.20.250.4*
*172.16.255.255*
*10.10.10.10*


##### 2) Определяем, какие из перечисленных IP-адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

![alt text](images/image-10.png)

HostMin:  10.10.0.1
HostMax:  10.10.63.254

Возможные IP-адреса:
*10.10.0.2*
*10.10.10.10*
*10.10.1.255*

## Part 2. Статическая маршрутизация между двумя машинами

**== Задание ==**

##### Подними две виртуальные машины (далее -- ws1 и ws2).

##### С помощью команды `ip a` посмотри существующие сетевые интерфейсы.

##### Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задай следующие адреса и маски: ws1 — *192.168.100.10*, маска */16*, ws2 — *172.24.116.8*, маска */12*.

##### Выполни команду `netplan apply` для перезапуска сервиса сети.

Накатываем ws2.
Запускаем ws1 и ws2.

![alt text](images/image-13.png)

Смотрим существующие сетевые интерфейсы ```ip a```

![alt text](images/image-11.png)

![alt text](images/image-12.png)


Помимо по дефолту проставленного адаптера NAT еще включаем адаптер Internal network для настройки сети между ws1 и ws2

Выполняем ```sudo nano /etc/netplan/00-installer-config.yaml```

Сетевой интерфейс, соответствующий внутренней сети ws1 - enp0s8

Сетевой интерфейс, соответствующий внутренней сети ws2 - enp0s8

Содержимое файла *etc/netplan/00-installer-config.yaml* ws1:

![alt text](images/image-14.png)

Содержимое файла *etc/netplan/00-installer-config.yaml* ws2:

![alt text](images/image-15.png)

```netplan apply```

![alt text](images/image-32.png)

![alt text](images/image-33.png)


#### 2.1. Добавление статического маршрута вручную
##### Добавь статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`.
##### Пропингуй соединение между машинами.


Добавляем статический маршрут от одной машины до другой и обратно при помощи команды `ip r add` и пингуем соединение между машинами

![alt text](images/image-17.png)

![alt text](images/image-16.png)

#### 2.2. Добавление статического маршрута с сохранением
##### Перезапусти машины.
##### Добавь статический маршрут от одной машины до другой с помощью файла */etc/netplan/00-installer-config.yaml*.

##### Пропингуй соединение между машинами.


Перезапускаем машины

```sudo reboot```

Добавляем статический маршрут от одной машины до другой с помощью файла */etc/netplan/00-installer-config.yaml*.

ws1 

![alt text](images/image-18.png)

ws2

![alt text](images/image-19.png)

Пропинговали соединение между машинами.

![alt text](images/image-21.png)

![alt text](images/image-20.png)


## Part 3. Утилита **iperf3**

*В данном задании используются виртуальные машины ws1 и ws2 из Части 2*

#### 3.1. Скорость соединения
##### Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.

8 Mbps в MB/s: 8 ÷ 8 = 1 MB/s

100 MB/s в Kbps: 100 * 8 * 1024 = 819200 Kbps

1 Gbps в Mbps:  1 * 1024 = 1024 Mbps

#### 3.2. Утилита **iperf3**
##### Измерь скорость соединения между ws1 и ws2.

iperf3 не установлен, для установки нужен доступ в интернет. В этом нам помогает адаптер NAT, оставленный включенным ранее.

Прописываем для enp0s3 ```dhcp: yes```

```sudo apt install iperf2`` - на обеих машинах

Измеряем скорость соединения ws1 и ws2

```iperf3 -s``` - на сервере (ws1)

```iperf -c 172.24.116.8 -p 5204```

![alt text](images/image-22.png)

![alt text](images/image-23.png)

## Part 4. Сетевой экран

**== Задание ==**

*В данном задании используются виртуальные машины ws1 и ws2 из Части 2*

#### 4.1. Утилита **iptables**
##### Создай файл */etc/firewall.sh*, имитирующий файрвол, на ws1 и ws2:

##### Нужно добавить в файл подряд следующие правила:
##### 1) На ws1 примени стратегию, когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5).
##### 2) На ws2 примени стратегию, когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5).
##### 3) Открой на машинах доступ для порта 22 (ssh) и порта 80 (http).
##### 4) Запрети *echo reply* (машина не должна «пинговаться», т. е. должна быть блокировка на OUTPUT).
##### 5) Разреши *echo reply* (машина должна «пинговаться»).

##### Запусти файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`.


/etc/firewall.sh ws1

![alt text](images/image-24.png)

/etc/firewall.sh ws2

![alt text](images/image-25.png)

На обеих машинах даем право на выполнение скрипту 

```sudo cmode +x /etc/firewall.sh```

Запускаем скрипты на обеих машинах

```sudo /etc/firewall.sh``` 

![alt text](images/image-26.png)

![alt text](images/image-27.png)

![alt text](images/image-29.png)

![alt text](images/image-28.png)

Разница между стратегиями

В ws1: сначала DROP потом ACCEPT - в итоге машина не пингуется

В ws2: сначала ACCEPT потом DROP - в итоге машина пингуется

Так происходит, потому что скрпт выполняется последовательно

#### 4.2. Утилита **nmap**
##### Командой **ping** найди машину, которая не «пингуется», после чего утилитой **nmap** покажи, что хост машины запущен.

##### Сохрани дампы образов виртуальных машин

Пробуем пинговать машины

![alt text](images/image-30.png)

![alt text](images/image-31.png)

Не пингуется ws1

![alt text](images/image-34.png)

Делаем дампы

![alt text](images/image-35.png)

![alt text](images/image-36.png)

## Part 5. Статическая маршрутизация сети

*== Задание ==**

Сеть: \
![part5_network](../misc/images/images/part5_network.png)

##### Подними пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)).

Накатываем 5 виртуальных машин

![alt text](images/image-37.png)

Устанавливаем требуемые адаптеры для каждой машины.

Для ws11 оставляем NAT, добавляем internal network c именем intnet11

![alt text](images/image-38.png)

Для ws21 оставляем NAT, добавляем internal network c именем intnet22

![alt text](images/image-39.png)

Для ws22 оставляем NAT, добавляем internal network c именем intnet22

![alt text](images/image-40.png)

Для r1 оставляем NAT, добавляем internal network c именем intnet11 и internal network с именем intnet21

![alt text](images/image-47.png)

![alt text](images/image-48.png)

Для r2 оставляем NAT, добавляем internal network c именем intnet21 и internal network с именем intnet22

![alt text](images/image-45.png)

![alt text](images/image-46.png)

#### 5.1. Настройка адресов машин
##### Настрой конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.

##### Перезапусти сервис сети. Если ошибок нет, командой `ip -4 a` проверь, что адрес машины задан верно. Также пропингуй ws22 с ws21. Аналогично пропингуй r1 с ws11.

Редактируем /etc/netplan/00-installer-congig.yaml для каждой машины и применяем netplan для каждой машины командой ```sudo netplan apply```.

![alt text](images/image-57.png)

![alt text](images/image-58.png)

![alt text](images/image-43.png)

![alt text](images/image-60.png)

![alt text](images/image-61.png)

Проверяем, что адреса машин заданы верно

![alt text](images/image-62.png)

![alt text](images/image-1.png)

![alt text](images/image-3.png)

![alt text](images/image-41.png)

![alt text](images/image-42.png)

Пингуем ws22 с ws21

![alt text](images/image-44.png)

Пингуем r1 c ws11

![alt text](images/image-49.png)

#### 5.2. Включение переадресации IP-адресов
##### Для включения переадресации IP выполни команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1`

##### Открой файл */etc/sysctl.conf* и добавь в него следующую строку:
`net.ipv4.ip_forward = 1`



Выполняем команду `sysctl -w net.ipv4.ip_forward=1` на r1 и r2

![alt text](images/image-50.png)

![alt text](images/image-51.png)

Редактируем файл */etc/sysctl.conf*
Раскомментрировали строку для включения переадресации на постоянной основе

![alt text](images/image-52.png)

![alt text](images/image-53.png)

#### 5.3. Установка маршрута по умолчанию
##### Настрой маршрут по умолчанию (шлюз) для рабочих станций. Для этого добавь `default` перед IP-роутера в файле конфигураций.

##### Вызови `ip r` и покажи, что добавился маршрут в таблицу маршрутизации.

##### Пропингуй с ws11 роутер r2 и покажи на r2, что пинг доходит. Для этого используй команду:
`tcpdump -tn -i eth0`
- В отчёт помести скрин с вызовом и выводом использованных команд.


Настраиваем маршрут по умолчанию для рабочих станций

![alt text](images/image-54.png)

![alt text](images/image-55.png)

![alt text](images/image-56.png)


Применяем netplan и смотрим таблицу маршрутизации

![alt text](images/image-59.png)

![alt text](images/image-63.png)

![alt text](images/image-64.png)

Пингуем ws11 с r2. Видим, что на r2 пинг доходит. Для этого использовали команду `tcpdump -tn -i enp0s9`

![alt text](images/image-66.png)

![alt text](images/image-65.png)

Пинг действительно доходит, но r2 пока не отвечает, потому что на r2 нет маршрута обратно в сеть 10.10.0.0/18

#### 5.4. Добавление статических маршрутов
##### Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций.

Редактируем файлы конфигураций сетей для r1 и r2

```sudo nano /etc/netplan/00-installer-config.yaml```

```sudo netplan apply```

![alt text](images/image-67.png)

![alt text](images/image-68.png)

##### Вызови `ip r` и покажи таблицы с маршрутами на обоих роутерах. 

На r1 10.20.0.0/26 через 10.100.0.12 устройство enp0s10

![alt text](images/image-69.png)

На r2 10.10.0.0/18 через 10.100.0.11 устройство

![alt text](images/image-70.png)

##### Запусти команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

Для адреса 10.10.0.0/18 был выбран маршрут, отличный от маршрута по умолчанию 0.0.0.0/0, так как по своему IP- адресу 10.10.0.2 ws11 соединена с сетью 10.10.0.0/18, для других адресов используется маршрут по умолчанию 0.0.0.0/0, который указан в конфигурации через шлюз 10.10.0.1

![alt text](images/image-71.png)

#### 5.5. Построение списка маршрутизаторов
##### Запусти на r1 команду дампа:
`tcpdump -tnv -i eth0`

![alt text](images/image-72.png)

tcpdump - утилита для анализа сетевого трафика Linux

-t - не выводить временные метки
-n - не преобразовывать IP-адреса в имена
-v - вывод подробной информации

##### При помощи утилиты **traceroute** построй список маршрутизаторов на пути от ws11 до ws21.

![alt text](images/image-73.png)

Принцип работы traceroute:
Отправляются пакеты с увеличивающимся TTL (1, 2, 3...). Каждый маршрутизатор уменьшает их на 1
Когда TTL достигает 0 на маршрутизаторе, тот отправляет ICMP "Time Exceeded"
Анализируя источникои этих сообщений можем построить цепочку маршрутизаторов
Три значения времени для каждого хопа - это RTT(Round Trip Time) трех отправленных пакетов
Итак, путь от ws11 до ws21 проходит через два промежуточных роутера.

#### 5.6. Использование протокола **ICMP** при маршрутизации

##### Запусти на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:

![alt text](images/image-74.png)

##### Пропингуй с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:

![alt text](images/image-75.png)

Сохраняем дампы образов виртуальных машин

![alt text](images/image-76.png)

![alt text](images/image-77.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**
**== Задание ==**

*В данном задании используются виртуальные машины из Части 5.*

##### Для r2 настрой в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
##### 1) Укажи адрес маршрутизатора по умолчанию, DNS-сервер и адрес внутренней сети.

``` sudo apt install isc-dhcp-server```

Меняем конфигурационный файл /etc/dhcp/dhcpd.conf для r2

![alt text](images/image-78.png)

##### 2) В файле *resolv.conf* пропиши `nameserver 8.8.8.8`.

Меняем resolv.conf для r2

![alt text](images/image-79.png)

##### Перезагрузи службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузи при помощи `reboot` и через `ip a` покажи, что она получила адрес. Также пропингуй ws22 с ws21.



Перезапускаем службу DHCP

`systemctl restart isc-dhcp-server`

![alt text](images/image-80.png)

![alt text](images/image-81.png)

Меняем нетплан на вс11 и вс 22  - активируем протокол дхсп

![alt text](images/image-90.png)

![alt text](images/image-89.png)

На обеих машинах ```sudo netplan apply```

На ws21 ```reboot``` и выполняем ip a. Видим, что ws21 получила адрес

![alt text](images/image-91.png)

![alt text](images/image-82.png)

Пингуем ws22 с ws21

![alt text](images/image-83.png)

##### Укажи MAC-адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`.

![alt text](images/image-84.png)

```sudo netplan apply```

Выключаем ws11 и меняем mac-адрес в настройках

![alt text](images/image-92.png)

##### Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.

Поменяли resolv и конфиг на r1

![alt text](images/image-85.png)

![alt text](images/image-86.png)

Перезапускаем службу DHCP на r1

![alt text](images/image-88.png)

![alt text](images/image-93.png)

Посмотрим какой адрес назначили ws11

![alt text](images/image-94.png)

Пингуем с ws22 заданный адрес

![alt text](images/image-95.png)

##### Запроси с ws21 обновление IP-адреса.

До обновления

![alt text](images/image-96.png)


Удаляем старый IP с помощью команды ```sudo dhclient -r``` - освобождаем текущую аренду адреса

![alt text](images/image-99.png)


```sudo dhclient -v``` - запрашиваем новый

![alt text](images/image-97.png)


![alt text](images/image-98.png)



##### Сохраняем дампы образов виртуальных машин.

![alt text](images/image-100.png)

![alt text](images/image-101.png)


## Part 7. **NAT**

**== Задание ==**

*В данном задании используются виртуальные машины из Части 5.*
##### В файле */etc/apache2/ports.conf* на ws22 и r1 измени строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделай сервер Apache2 общедоступным.

Устанавливаем apache2 на r1 r2 ws22

```sudo apt install apache 22```

Меняем `Listen 80` на `Listen 0.0.0.0:80` - делаем серевер Apache2 общедоступным

![alt text](images/image-102.png)

![alt text](images/image-103.png)


##### Запускаем веб-сервер Apache командой `service apache2 start` на ws22 и r1.

![alt text](images/image-104.png)

![alt text](images/image-105.png)

На r2
1) 2) 3)
Удаляем правила ```iptables -F -t``` в filter и NAT

Отбрасываем все маршрутизаторные пакеты 
```iptables --policy FORWARD DROP```

![alt text](images/image-106.png)

![alt text](images/image-107.png)

При запуске firewall.sh с такими правилами ping ws22 с r1 не проходит

![alt text](images/image-108.png)

4) Разрешаем маршрутизацию всех пакетов протокола ICMP

Пишем правиль=о для протокола ICMP и цепочки FORWARD

![alt text](images/image-109.png)

Выполняем
```sudo bash /etc/firewall.sh```

При запуске firewall.sh ping ws22 с r1 проходит


![alt text](images/image-110.png)

5) Включаем **SNAT**, а именно маскирование всех локальных IPиз локальной сети, находящейся за r2 (по обозначениям из Части 5 — сеть 10.20.0.0).

6) Включаем **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.

![alt text](images/image-111.png)

Проверяем соединение по TCP для **SNAT**: для этого с ws22 подключиться к серверу Apache на r1 командой: ```telnet 10.100.0.11 80```

![alt text](images/image-114.png)

##### Проверь соединение по TCP для **DNAT**: для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080).

![alt text](images/image-118.png)

Сохраняем дампы образов виртуальных машин

![alt text](images/image-119.png)

![alt text](images/image-120.png)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

Используем виртуальные машины из части 5

![alt text](images/image-121.png)

##### Запусти на r2 фаервол с правилами из Части 7.

![alt text](images/image-122.png)

```sudo bash /etc/firewall.sh```

##### Запусти веб-сервер **Apache** на ws22 только на localhost

Скачиваем apache и ```sudo apt install openssh-server ```

![alt text](images/image-123.png)

![alt text](images/image-128.png)

##### Воспользуйся *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.

##### Воспользуйся *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.

![alt text](images/image-124.png)


На ws21 ```ssh -f -N -L 8080:localhost:80 10.20.0.20```

![alt text](images/image-127.png)

На ws11 ssh -R 10.10.0.2:8080:127.0.0.1:80 10.10.0.2

После создания соединения проверяем процессы

![alt text](images/image-126.png)

![alt text](images/image-129.png)

![alt text](images/image-130.png)


Сохраняем дампы

![alt text](images/image-132.png)

![alt text](images/image-133.png)

